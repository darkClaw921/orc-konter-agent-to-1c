text=r"""
## Таблица 2 (часть 2)

| **№ п\п**   | **Наименование услуги (работ)**                                                                                                                                                                         | **Ед. изм.**   | **Цена за единицу услуги (работы), руб. (НДС не облагается)**   |
|:------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------|:----------------------------------------------------------------|
|             | Услуги по заправке картриджа МФУ M7300FDN                                                                                                                                                               | усл.ед.        | 1 494,00                                                        |
|             | Услуги по замене включая запчасть: RM1-6878-010CN – Оригинальный Блок лазера Для HP LaserJet P1102 / M1132mfp / M1212mfp / M1214mfp / M1217mfp                                                          | усл.ед.        | 1 568,70                                                        |
|             | Услуги по замене включая запчасть: TK-170 Оригинальный Тонер-картридж Для Kyocera FS-1320 / 1370 / ECOSYS P2135                                                                                         | усл.ед.        | 6 814,30                                                        |
|             | Услуги по техническому обслуживанию МФУ FS-1128 MFP                                                                                                                                                     | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: 301022055001 – Оригинальный Блок лазера Для Pantum P2200 / P2207 / P2500 / P2506 / P2516 / P2518 / M6500 / M6506 / M6507 / M6550 / M6557 / M6607                     | усл.ед.        | 2 656,00                                                        |
|             | Услуги по заправке картриджа МФУ Samsung SCX-483x 5x3x Series                                                                                                                                           | усл.ед.        | 1 162,00                                                        |
|             | Услуги по техническому обслуживанию принтера Pantum P2518                                                                                                                                               | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: 301022090001 - Оригинальная Печь, в сборе Для Pantum P2200 / P2207 / P2500 / P2506 / P2516 / P2518 / M6500 / M6506 / M6507 / M6550 / M6557 / M6607                   | усл.ед.        | 3 984,00                                                        |
|             | Услуги по техническому обслуживанию МФУ HP LaserJet M3035xs MFP                                                                                                                                         | усл.ед.        | 1 411,00                                                        |
|             | Услуги по замене включая запчасть: 019-11833-006 Оригинальная Площадка отделения (торм.) CC3010 Для Riso RZ370/Riso RZ570/Riso EZ370/Riso RZ970/Riso ComColor3010                                       | усл.ед.        | 1 186,90                                                        |
|             | Услуги по замене включая запчасть: RM1-7365-000CN – Оригинальная Площадка отделения бумаги из кассеты Для HP LaserJet Pro 400 M401 / 400 MFP M425                                                       | усл.ед.        | 688,90                                                          |
|             | Услуги по техническому обслуживанию МФУ ECOSYS M4125idn                                                                                                                                                 | усл.ед.        | 1 494,00                                                        |
|             | Услуги по заправке картриджа принтера FS-1060DN                                                                                                                                                         | усл.ед.        | 996,00                                                          |
|             | Услуги по замене включая запчасть: DV-1110 - Оригинальный Блок проявки Для Kyocera FS-1040 / 1060 / 1020MFP / 1025MFP / 1120MFP / 1125MFP                                                               | усл.ед.        | 3 735,00                                                        |
|             | Услуги по заправке картриджа принтера HP LaserJet P1102w                                                                                                                                                | усл.ед.        | 1 037,50                                                        |
|             | Услуги по техническому обслуживанию МФУ ECOSYS M2035dn                                                                                                                                                  | усл.ед.        | 1 286,50                                                        |
|             | Услуги по замене включая запчасть: DV-1150 - Оригинальный Блок проявки Для Kyocera ECOSYS P2235 / M2135 / M2635 / M2735dw                                                                               | усл.ед.        | 10 956,00                                                       |
|             | Услуги по техническому обслуживанию принтера ECOSYS P2135dn                                                                                                                                             | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: 302LK94140 – Оригинальный Комплект роликов захвата / подачи / отделения бумаги                                                                                       | усл.ед.        | 4 955,10                                                        |
|             | Услуги по замене включая запчасть: MK-6115 – Оригинальный Комплект технического обслуживания Для Kyocera ECOSYS M4125 / M4132                                                                           | усл.ед.        | 30 162,20                                                       |
|             | Услуги по замене включая запчасть: CF540A- Оригинальный картридж Для HP Color LaserJet Pro M254 / MFP M280 / M281                                                                                       | усл.ед.        | 5 893,00                                                        |
|             | Услуги по замене включая запчасть: TK-1140 Оригинальный тонер-картридж Для Kyocera FS-1035MFP / 1135MFP / ECOSYS M2035 / M2535                                                                          | усл.ед.        | 7 121,40                                                        |
|             | Услуги по заправке картриджа принтера Brother HL-1110R                                                                                                                                                  | усл.ед.        | 747,00                                                          |
|             | Услуги по замене включая запчасть: LK-160 - Оригинальный Блок лазера Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                                            | усл.ед.        | 14 442,00                                                       |
|             | Услуги по техническому обслуживанию МФУ FS-1125MFP                                                                                                                                                      | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: DV-1140 – Оригинальный Блок проявки Для Kyocera FS-1320 / 1370 / 1035MFP / 1135MFP / ECOSYS P2035 / P2135 / M2035 / M2535                                            | усл.ед.        | 10 873,00                                                       |
|             | Услуги по техническому обслуживанию принтера HP LaserJet P2015                                                                                                                                          | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: F2A68-67914 – Оригинальный Комплект из ролика захвата и площадки отделения бумаги в лотке ручной подачи Для HP LaserJet Pro M304 / M404 / MFP M428 / Enterprise M406 | усл.ед.        | 4 316,00                                                        |
|             | Услуги по замене включая запчасть: 302PK94030 - Оригинальная Плата форматтера Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                                   | усл.ед.        | 21 497,00                                                       |
|             | Услуги по замене включая запчасть: TK-6115 Оригинальный Тонер-картридж Для Kyocera ECOSYS M4125 / M4132                                                                                                 | усл.ед.        | 8 341,50                                                        |
|             | Услуги по замене включая запчасть: CT-475 – Оригинальная Кассета на 500 листов, в сборе Для Kyocera ECOSYS M4125 / M4132                                                                                | усл.ед.        | 6 474,00                                                        |
|             | Услуги по заправке картриджа принтера LaserJet P1505                                                                                                                                                    | усл.ед.        | 1 079,00                                                        |
|             | Услуги по заправке картриджа принтера Pantum P2518                                                                                                                                                      | усл.ед.        | 1 328,00                                                        |
|             | Услуги по замене включая запчасть: FK-171 - Оригинальная Печь, в сборе (220В) Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                                   | усл.ед.        | 9 047,00                                                        |
|             | Услуги по замене включая запчасть: MK-170 – Оригинальный Комплект технического обслуживания Для Kyocera FS-1320 / 1370 / ECOSYS P2135                                                                   | усл.ед.        | 13 387,90                                                       |
|             | Услуги по заправке картриджа МФУ FS-1025MFP                                                                                                                                                             | усл.ед.        | 996,00                                                          |
|             | Услуги по заправке картриджа принтера HP LaserJet P2015                                                                                                                                                 | усл.ед.        | 1 826,00                                                        |
|             | Услуги по замене включая запчасть: MK-1110 – Оригинальный Комплект технического обслуживания Для Kyocera FS-1040 / 1060 / 1020MFP / 1025MFP / 1120MFP / 1125MFP                                         | усл.ед.        | 7 030,10                                                        |
|             | Услуги по заправке картриджа принтера Pantum P2506W                                                                                                                                                     | усл.ед.        | 1 162,00                                                        |
|             | Услуги по ремонту термопринтера BP41                                                                                                                                                                    | усл.ед.        | 2 988,00                                                        |
|             | Услуги по замене включая запчасть: Оригинальный комплект роликов ADF Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                                            | усл.ед.        | 3 486,00                                                        |
|             | Услуги по замене включая запчасть: RM2-4760-000CN – Оригинальная Печь, в сборе (220В) Для HP LaserJet P1102 / M1132mfp / M1212mfp / M1214mfp / M1217mfp                                                 | усл.ед.        | 9 686,10                                                        |
|             | Услуги по техническому обслуживанию МФУ M7300FDN                                                                                                                                                        | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: MK-6110 - Оригинальный Комплект для технического обслуживания узла автоматической подачи документов Для Kyocera ECOSYS M4125 / M4132                                 | усл.ед.        | 4 233,00                                                        |
|             | Услуги по заправке картриджа МФУ HP LaserJet M3035xs MFP                                                                                                                                                | усл.ед.        | 2 448,50                                                        |
|             | Услуги по техническому обслуживанию МФУ FS-1025MFP                                                                                                                                                      | усл.ед.        | 1 037,50                                                        |
|             | Услуги по техническому обслуживанию принтера Brother HL-5350DN                                                                                                                                          | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: CF543X- Оригинальный картридж Для HP Color LaserJet Pro M254 / MFP M280 / M281                                                                                       | усл.ед.        | 13 221,90                                                       |
|             | Услуги по заправке картриджа МФУ ECOSYS M2030dn                                                                                                                                                         | усл.ед.        | 996,00                                                          |
|             | Услуги по техническому обслуживанию МФУ Samsung SCX-483x 5x3x Series                                                                                                                                    | усл.ед.        | 1 286,50                                                        |
|             | Услуги по заправке картриджа принтера LaserJet Pro M104A                                                                                                                                                | усл.ед.        | 996,00                                                          |
|             | Услуги по техническому обслуживанию МФУ ECOSYS M2530dn                                                                                                                                                  | усл.ед.        | 1 286,50                                                        |
|             | Услуги по замене включая запчасть: MK-1130 – Оригинальный Комплект технического обслуживания Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                    | усл.ед.        | 15 106,00                                                       |
|             | Услуги по замене включая запчасть: RM2-1652-010CN – Оригинальная Печь, в сборе Для HP LaserJet Pro M104 / MFP M132                                                                                      | усл.ед.        | 9 661,20                                                        |
|             | Услуги по техническому обслуживанию принтера LaserJet 1010                                                                                                                                              | усл.ед.        | 1 037,50                                                        |
|             | Услуги по заправке картриджа принтера  ECOSYS P2135dn                                                                                                                                                   | усл.ед.        | 1 079,00                                                        |
|             | Услуги по техническому обслуживанию принтера Pantum P2506W                                                                                                                                              | усл.ед.        | 1 037,50                                                        |
|             | Услуги по техническому обслуживанию принтера  Brother HL-1110R                                                                                                                                          | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: CF542A- Оригинальный картридж Для HP Color LaserJet Pro M254 / MFP M280 / M281                                                                                       | усл.ед.        | 5 893,00                                                        |
|             | Услуги по заправке картриджа принтера HP LaserJet M402dn                                                                                                                                                | усл.ед.        | 1 950,50                                                        |
|             | Услуги по замене включая запчасть: 301022062001 – Оригинальная Площадка отделения бумаги Для Pantum P2200 / P2207 / P2500 / P2506 / P2516 / P2518 / M6500 / M6506 / M6507 / M6550 / M6557 / M6607       | усл.ед.        | 738,70                                                          |
|             | Услуги по заправке картриджа МФУ ECOSYS M2735dn                                                                                                                                                         | усл.ед.        | 996,00                                                          |
|             | Услуги по техническому обслуживанию МФУ Xerox WorkCentre 3345                                                                                                                                           | усл.ед.        | 1 286,50                                                        |
|             | Услуги по заправке картриджа принтера Brother HL-5350DN                                                                                                                                                 | усл.ед.        | 747,00                                                          |
|             | Услуги по замене включая запчасть: PC-211EV- Оригинальный тонер-картридж Для Pantum P2200 / P2207 / P2500 / P2506 / Услуги по замене: P2516 / P2518 / M6500 / M6506 / M6507 / M6550 / M6557 / M6607     | усл.ед.        | 2 656,00                                                        |
|             | Услуги по техническому обслуживанию ризографа Riso R200                                                                                                                                                 | усл.ед.        | 2 075,00                                                        |
|             | Услуги по замене включая запчасть: LK-170 – Оригинальный Блок лазера Для Kyocera FS-1320 / 1370 / 1035MFP / 1135MFP / ECOSYS P2035 / P2135 / M2035 / M2535                                              | усл.ед.        | 12 616,00                                                       |
|             | Услуги по техническому обслуживанию принтера LBP-2900                                                                                                                                                   | усл.ед.        | 1 037,50                                                        |
|             | Услуги по техническому обслуживанию МФУ FS-1030MFP                                                                                                                                                      | усл.ед.        | 1 037,50                                                        |
|             | Услуги по замене включая запчасть: CF259A – Оригинальный картридж Для HP LaserJet Pro M304 / M404 / MFP M428 / Enterprise M406                                                                          | усл.ед.        | 9 528,40                                                        |
|             | Услуги по замене включая запчасть: CF543X- Оригинальный картридж Для HP Color LaserJet Pro M254 / MFP M280 / M281                                                                                       | усл.ед.        | 9 412,20                                                        |
|             | Услуги по замене включая запчасть: CF540X- Оригинальный картридж Для HP Color LaserJet Pro M254 / MFP M280 / M281                                                                                       | усл.ед.        | 9 412,20                                                        |
|             | Услуги по заправке картриджа МФУ ECOSYS M2530dn                                                                                                                                                         | усл.ед.        | 996,00                                                          |
|             | Услуги по замене включая запчасть: DK-150 - Оригинальный Драм-картридж Для Kyocera FS-1030MFP / 1130MFP / ECOSYS M2030 / M2530                                                                          | усл.ед.        | 8 208,70                                                        |
|             | Услуги по замене включая запчасть: RM1-2084-000CN – Оригинальный Блок лазера Для HP LJ 1010/1012/1015/1020                                                                                              | усл.ед.        | 1 610,20                                                        |
|             | Услуги по заправке картриджа принтера HP LaserJet 1020                                                                                                                                                  | усл.ед.        | 996,00                                                          |
|             | Услуги по заправке картриджа МФУ ECOSYS M2135dn                                                                                                                                                         | усл.ед.        | 996,00                                                          |
Return ONLY valid JSON:
{"services": [
  {"name": "Услуги по замене включая запчасть: CE285A- Оригинальный картридж Для HP LaserJet P1102", "quantity": null, "unit": "усл.ед.", "unit_price": null, "total_price": 7702.40, "description": null},
  {"name": "Услуги по техническому обслуживанию принтера FS-1060DN", "quantity": null, "unit": "усл.ед.", "unit_price": null, "total_price": 1037.50, "description": null},
  ...
]}
"""


import asyncio
import os
import sys
import json
import re
from pathlib import Path
from dotenv import load_dotenv

# Добавляем путь к backend в sys.path
sys.path.insert(0, str(Path(__file__).parent / 'backend'))

from app.config import settings
from openai import AsyncOpenAI

async def test_extract_services():
    system_prompt = """You are an expert at extracting service information from Russian contracts.
        Extract all services with their prices and quantities. Return only valid JSON.
You are an expert at extracting service and product information from Russian contracts and specifications.

Your task is to extract EVERY SINGLE service/product line from tables in the document. Each row in a table = one service entry.

CRITICAL: Extract ALL rows from tables, not just summaries. If there are 100 services in a table, return all 100.

SEARCH FOR TABLES WITH:
1. Headers: "Наименование", "Наименование услуги/товара", "Ед. изм.", "Цена", "Стоимость", "Сумма"
2. Sections: "Спецификация", "Перечень услуг", "Перечень работ", "Приложение"
3. Service patterns: "Услуги по...", "Услуги по замене включая запчасть:", "Услуги по заправке", "Услуги по техническому обслуживанию"

PRICE FORMAT RULES:
- Russian prices use SPACE as thousands separator and COMMA as decimal: "7 702,40" means 7702.40
- Convert to number: "26 360,80" → 26360.80, "1 079,00" → 1079.00
- If price column exists, it's usually total_price (not unit_price)

FOR EACH TABLE ROW EXTRACT:
- name (string, REQUIRED) - Full service name exactly as written, including part numbers and model names
  Examples:
  - "Услуги по замене включая запчасть: CE285A- Оригинальный картридж Для HP LaserJet P1102"
  - "Услуги по техническому обслуживанию принтера FS-1060DN"
  - "Услуги по заправке картриджа принтера LBP-2900"
- quantity (number or null) - If quantity column exists
- unit (string or null) - Unit of measurement: "усл.ед.", "шт", "час", "день", "мес", "компл", etc.
- unit_price (number or null) - Price per unit if separate column exists
- total_price (number or null) - Total price/cost for this line item (convert from Russian format)
- description (string or null) - Additional notes if any

RULES:
1. Extract EVERY row as a separate service - do not skip or combine rows
2. Keep the FULL service name including all part numbers (CE285A, DK-1110, etc.) and equipment models
3. Convert prices from Russian format (space separator, comma decimal) to numbers
4. If only one price column exists, use it as total_price
5. If table has no quantity column, set quantity to null (not 1)
6. Return empty array if no services found, never return null

DOCUMENT TEXT:"""

    user_prompt = text
    from dotenv import load_dotenv
    load_dotenv()
    from pprint import pprint
    client = AsyncOpenAI(api_key=os.getenv('LLM_API_KEY'), timeout=300)

    response = await client.chat.completions.create(
        # model="gpt-4o-mini",
        model="gpt-5-mini-2025-08-07",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        # temperature=0.5,
        # max_tokens=16384,
        timeout=300
    )
    print(response)
    result_text = response.choices[0].message.content
    if not result_text:
        raise ValueError("Empty response from LLM")

    # Извлекаем JSON из markdown блока кода, если он есть
    json_text = result_text.strip()

    # Проверяем, обернут ли JSON в markdown блок кода
    json_match = re.search(r'```(?:json)?\s*(\[.*?\]|\{.*?\})\s*```', json_text, re.DOTALL)
    if json_match:
        json_text = json_match.group(1)
    else:
        # Если нет markdown блока, пытаемся найти JSON массив или объект напрямую
        json_match = re.search(r'\[.*\]|\{.*\}', json_text, re.DOTALL)
        if json_match:
            json_text = json_match.group(0)
    print(json_text)
    result_json = json.loads(json_text)
    pprint(result_json)
    return result_json

if __name__ == "__main__":
    asyncio.run(test_extract_services())