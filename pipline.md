                                                                                                                                                                                         
  ---                                                                                                                                                                                      
  ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° Ğ² 1Ğ¡                                                                                                                             
                                                                                                                                                                                           
  ğŸ”„ ĞĞ‘Ğ©ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡Ğ                                                                                                                                                                  

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ ĞšĞĞĞ¢Ğ ĞĞšĞ¢Ğ                                â”‚
  â”‚                   POST /api/v1/contracts/upload                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                          CELERY TASK                                        â”‚
  â”‚                    process_contract_task()                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                       ORCHESTRATOR.process_contract()                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ 1. _load_document()        â†’ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° DOCX                           â”‚  â”‚
  â”‚  â”‚ 2. _extract_text()         â†’ Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°                       â”‚  â”‚
  â”‚  â”‚ 3. _extract_contract_data()â†’ Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· LLM             â”‚  â”‚
  â”‚  â”‚ 4. _extract_all_services() â†’ Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³ Ñ‡ĞµÑ€ĞµĞ· LLM              â”‚  â”‚
  â”‚  â”‚ 5. _validate_data()        â†’ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ                â”‚  â”‚
  â”‚  â”‚ 6. _check_existing_in_1c() â†’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚Ğ°            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                    â”‚                                        â”‚
  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
  â”‚                   â–¼                                 â–¼                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚ ĞšĞĞĞ¢Ğ ĞĞ“Ğ•ĞĞ¢ ĞĞ• ĞĞĞ™Ğ”Ğ•Ğ      â”‚    â”‚ ĞšĞĞĞ¢Ğ ĞĞ“Ğ•ĞĞ¢ ĞĞĞ™Ğ”Ğ•Ğ                 â”‚   â”‚
  â”‚  â”‚ _create_counterparty_in_1câ”‚    â”‚ _add_agreement_to_existing        â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸ“ ĞŸĞ£Ğ¢Ğ¬ 1: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ° (Endpoint)

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/api/v1/endpoints/contracts.py

  Endpoint: POST /api/v1/contracts/upload

  @router.post("/upload")
  async def upload_contract(
      file: UploadFile = File(...),     # DOCX Ñ„Ğ°Ğ¹Ğ»
      current_user: dict = Depends(...),
      db: Session = Depends(get_db)
  )

  ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°:

  POST /api/v1/contracts/upload
  Content-Type: multipart/form-data

  file: contract_123.docx (binary)

  Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸:

  1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ .docx Ğ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° (â‰¤50MB)
  2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° - StorageService.save_file(file) â†’ /uploads/contracts/contract_123_uuid.docx
  3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ‘Ğ” - Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° contracts
  4. Ğ—Ğ°Ğ¿ÑƒÑĞº Celery task

  ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ² Ğ‘Ğ”:

  Contract(
      id=123,
      filename="contract_123.docx",
      file_path="/uploads/contracts/contract_123_uuid.docx",
      status=ProcessingStatus.UPLOADED,
      user_id=1,
      created_at="2024-01-15T10:30:00"
  )

  ĞÑ‚Ğ²ĞµÑ‚ API:

  {
    "contract_id": 123,
    "filename": "contract_123.docx",
    "status": "uploaded",
    "task_id": "abc-123-def-456",
    "created_at": "2024-01-15T10:30:00Z"
  }

  ---
  âš™ï¸ ĞŸĞ£Ğ¢Ğ¬ 2: Celery Task

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/tasks/processing_tasks.py

  Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: process_contract_task(contract_id, document_path)

  @celery_app.task(bind=True, name="process_contract_task")
  def process_contract_task(self, contract_id: int, document_path: str):

  Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:

  contract_id = 123
  document_path = "/uploads/contracts/contract_123_uuid.docx"

  Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²:

  # 1. Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”
  db = SessionLocal()

  # 2. Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹
  state_manager = StateManager(db)
  doc_processor = DocumentProcessor()
  llm_service = LLMService()
  validation_service = ValidationService()
  oneÑ_service = OneCService()
  progress_service = ProgressService(redis_client)

  # 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
  orchestrator = AgentOrchestrator(
      state_manager=state_manager,
      doc_processor=doc_processor,
      llm_service=llm_service,
      validation_service=validation_service,
      oneÑ_service=oneÑ_service,
      progress_service=progress_service
  )

  Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸:

  state = await orchestrator.process_contract(contract_id, document_path)

  ---
  ğŸ¯ ĞŸĞ£Ğ¢Ğ¬ 3: Orchestrator - Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Pipeline

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/agent/orchestrator.py

  Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: process_contract(contract_id, document_path)

  Ğ¨Ğ°Ğ³ 3.1: _extract_contract_data() - Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· LLM

  Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:
  state.raw_text = """
  Ğ”ĞĞ“ĞĞ’ĞĞ  â„– 123/2024
  Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³

  Ğ³. ĞœĞ¾ÑĞºĞ²Ğ°                                    15 ÑĞ½Ğ²Ğ°Ñ€Ñ 2024 Ğ³.

  ĞĞĞ "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº", Ğ˜ĞĞ 7707083893, ĞšĞŸĞŸ 770701001...
  Ğ¸Ğ¼ĞµĞ½ÑƒĞµĞ¼Ğ¾Ğµ Ğ´Ğ°Ğ»ĞµĞµ "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº", Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹, Ğ¸
  ĞĞĞ "Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ", Ğ˜ĞĞ 7708123456, ĞšĞŸĞŸ 770801001...
  Ğ¸Ğ¼ĞµĞ½ÑƒĞµĞ¼Ğ¾Ğµ Ğ´Ğ°Ğ»ĞµĞµ "Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ", Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹...

  Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑƒÑĞ»ÑƒĞ³ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 1 000 000 (ĞĞ´Ğ¸Ğ½ Ğ¼Ğ¸Ğ»Ğ»Ğ¸Ğ¾Ğ½) Ñ€ÑƒĞ±Ğ»ĞµĞ¹,
  Ğ² Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ ĞĞ”Ğ¡ 20% - 166 666,67 Ñ€ÑƒĞ±Ğ»ĞµĞ¹.

  ĞÑ‚ÑÑ€Ğ¾Ñ‡ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 30 (Ñ‚Ñ€Ğ¸Ğ´Ñ†Ğ°Ñ‚ÑŒ) ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹...
  """

  Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ (state.extracted_data):
  {
      "inn": "7707083893",
      "kpp": "770701001",
      "full_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "short_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "organizational_form": "ĞĞĞ",
      "legal_entity_type": "Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ»Ğ¸Ñ†Ğ¾",
      "role": "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº",

      "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
      "contract_number": "123/2024",
      "contract_date": "2024-01-15",
      "contract_price": 1000000.00,
      "vat_percent": 20.0,
      "vat_type": "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² Ñ†ĞµĞ½Ñƒ",

      "payment_terms": "ĞÑ‚ÑÑ€Ğ¾Ñ‡ĞºĞ° 30 ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹",
      "payment_deferral_days": 30,

      "customer": {
          "inn": "7707083893",
          "kpp": "770701001",
          "full_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
          "organizational_form": "ĞĞĞ"
      },
      "contractor": {
          "inn": "7708123456",
          "kpp": "770801001",
          "full_name": "ĞĞĞ \"Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ\"",
          "organizational_form": "ĞĞĞ"
      }
  }

  Ğ¨Ğ°Ğ³ 3.2: _extract_all_services() - Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³

  Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ² state.extracted_data['all_services']:
  {
      "all_services": [
          {
              "name": "ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ ĞŸĞ",
              "quantity": 100,
              "unit": "Ñ‡Ğ°ÑĞ¾Ğ²",
              "unit_price": 5000.00,
              "total_price": 500000.00
          },
          {
              "name": "Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°",
              "quantity": 12,
              "unit": "Ğ¼ĞµÑÑÑ†ĞµĞ²",
              "unit_price": 41666.67,
              "total_price": 500000.00
          }
      ]
  }

  Ğ¨Ğ°Ğ³ 3.3: _check_existing_in_1c() - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ² 1Ğ¡

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/agent/orchestrator.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ ~1050-1150)

  async def _check_existing_in_1c(self, state: AgentState):
      # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ˜ĞĞ
      inn = state.extracted_data.get("inn")
      inn_source = "root"

      if not inn:
          customer = state.extracted_data.get("customer", {})
          if customer.get("inn"):
              inn = customer["inn"]
              inn_source = "customer"
          else:
              contractor = state.extracted_data.get("contractor", {})
              if contractor.get("inn"):
                  inn = contractor["inn"]
                  inn_source = "contractor"

      state.counterparty_inn_source = inn_source

      # Ğ’Ñ‹Ğ·Ğ¾Ğ² OneCService
      result = await self.oneÑ_service.find_counterparty_by_inn(inn)

  Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ² OneCService:
  inn = "7707083893"

  ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ 1Ğ¡ (ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½):
  {
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "Description": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "Ğ˜ĞĞ": "7707083893",
      "ĞšĞŸĞŸ": "770701001"
  }

  ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ state:
  state.existing_counterparty_id = "550e8400-e29b-41d4-a716-446655440000"  # ĞµÑĞ»Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
  # Ğ¸Ğ»Ğ¸
  state.existing_counterparty_id = None  # ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½

  ---
  ğŸ†• Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ A: ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚ ĞĞ• Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/agent/orchestrator.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ ~1100-1227)

  Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: _create_counterparty_in_1c(state)

  Ğ¨Ğ°Ğ³ A.1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… - _prepare_counterparty_data(state)

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/agent/orchestrator.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ ~1343+)

  def _prepare_counterparty_data(self, state: AgentState) -> Dict[str, Any]:
      # Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ inn_source
      source_data = state.extracted_data
      if state.counterparty_inn_source == "customer":
          source_data = state.extracted_data.get("customer", {})
      elif state.counterparty_inn_source == "contractor":
          source_data = state.extracted_data.get("contractor", {})

      return {
          "inn": source_data.get("inn"),
          "kpp": source_data.get("kpp"),
          "full_name": source_data.get("full_name"),
          "short_name": source_data.get("short_name"),
          "organizational_form": source_data.get("organizational_form"),
          "legal_entity_type": source_data.get("legal_entity_type"),
          "role": state.extracted_data.get("role"),

          # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°
          "contract_name": state.extracted_data.get("contract_name"),
          "contract_number": state.extracted_data.get("contract_number"),
          "contract_date": state.extracted_data.get("contract_date"),
          "contract_price": state.extracted_data.get("contract_price"),
          "vat_percent": state.extracted_data.get("vat_percent"),
          "vat_type": state.extracted_data.get("vat_type"),

          # Ğ£ÑĞ»ÑƒĞ³Ğ¸
          "all_services": state.extracted_data.get("all_services"),
          "service_description": state.extracted_data.get("service_description"),
          "service_start_date": state.extracted_data.get("service_start_date"),
          "service_end_date": state.extracted_data.get("service_end_date"),

          # Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
          "payment_terms": state.extracted_data.get("payment_terms"),
          "payment_deferral_days": state.extracted_data.get("payment_deferral_days"),

          # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾
          "locations": state.extracted_data.get("locations"),
          "responsible_persons": state.extracted_data.get("responsible_persons"),
          "customer": state.extracted_data.get("customer"),
          "contractor": state.extracted_data.get("contractor"),
      }

  Ğ¨Ğ°Ğ³ A.2: Ğ’Ñ‹Ğ·Ğ¾Ğ² OneCService.create_counterparty()

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/services/oneÑ_service.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 102-250)

  Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:
  contract_data = {
      "inn": "7707083893",
      "kpp": "770701001",
      "full_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "short_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "organizational_form": "ĞĞĞ",
      "legal_entity_type": "Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ»Ğ¸Ñ†Ğ¾",
      "role": "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº",

      "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
      "contract_number": "123/2024",
      "contract_date": "2024-01-15",
      "contract_price": 1000000.00,
      "vat_percent": 20.0,
      "vat_type": "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² Ñ†ĞµĞ½Ñƒ",

      "all_services": [
          {"name": "ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸", "quantity": 100, "unit": "Ñ‡Ğ°ÑĞ¾Ğ²", ...}
      ],
      "payment_deferral_days": 30,
      ...
  }

  document_path = "/uploads/contracts/contract_123_uuid.docx"
  raw_text = "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°..."

  Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ params Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ create_counterparty():
  params = {
      "inn": "7707083893",
      "kpp": "770701001",
      "full_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "short_name": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      "legal_entity_type": "Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ»Ğ¸Ñ†Ğ¾",
      "organizational_form": "ĞĞĞ",
      "role": "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº",
      "is_supplier": False,    # Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ role
      "is_buyer": True,        # Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ role

      # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°
      "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
      "contract_number": "123/2024",
      "contract_date": "2024-01-15",  # ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ÑÑ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ
      "contract_price": 1000000.0,    # Decimal â†’ float
      "vat_percent": 20.0,
      "vat_type": "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² Ñ†ĞµĞ½Ñƒ",

      # Ğ£ÑĞ»ÑƒĞ³Ğ¸
      "services": [
          {"name": "ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸", "quantity": 100, "unit": "Ñ‡Ğ°ÑĞ¾Ğ²", ...}
      ],

      # Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ
      "allowed_debt_days": 30,
      "payment_terms": "ĞÑ‚ÑÑ€Ğ¾Ñ‡ĞºĞ° 30 ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹",

      "raw_text": "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚...",  # Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° "Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» Ğ¿Ğ¾Ğ´Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²"
      ...
  }

  HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº MCP Service:
  POST http://localhost:8001/command
  Content-Type: application/json

  {
      "command": "create_counterparty",
      "params": { ...params }
  }

  ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ MCP/1Ğ¡:
  {
      "status": "success",
      "result": {
          "uuid": "550e8400-e29b-41d4-a716-446655440001",
          "entity": {
              "Ref": "Catalog.ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹.550e8400-...",
              "Description": "ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
              "Ğ˜ĞĞ": "7707083893"
          },
          "agreement_uuid": "550e8400-e29b-41d4-a716-446655440002"
      }
  }

  Ğ¨Ğ°Ğ³ A.3: ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° - attach_file()

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/services/oneÑ_service.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 252-347)

  await self.attach_file(
      entity_uuid="550e8400-e29b-41d4-a716-446655440001",  # UUID ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
      file_path="/uploads/contracts/contract_123_uuid.docx",
      agreement_uuid="550e8400-e29b-41d4-a716-446655440002"  # UUID Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°
  )

  HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:
  {
      "command": "attach_file",
      "params": {
          "counterparty_uuid": "550e8400-e29b-41d4-a716-446655440001",
          "agreement_uuid": "550e8400-e29b-41d4-a716-446655440002",
          "file_path": "/uploads/contracts/contract_123_uuid.docx",
          "file_name": "contract_123_uuid.docx"
      }
  }

  Ğ¨Ğ°Ğ³ A.4: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”

  Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° counterparty_1c:
  Counterparty1C(
      id=1,
      contract_data_id=123,
      entity_uuid="550e8400-e29b-41d4-a716-446655440001",
      entity_name="ĞĞĞ \"Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº\"",
      agreement_uuid="550e8400-e29b-41d4-a716-446655440002",
      status_1c=OneCStatus.CREATED,
      created_in_1c_at="2024-01-15T10:35:00",
      response_from_1c={...},  # Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
      error_from_1c=None
  )

  ---
  ğŸ“ Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ B: ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚ ĞĞĞ™Ğ”Ğ•Ğ - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/agent/orchestrator.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 1228-1342)

  Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ: _add_agreement_to_existing_counterparty(state)

  Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°:
  if state.existing_counterparty_id:  # UUID Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
      await self._add_agreement_to_existing_counterparty(state)
  else:
      await self._create_counterparty_in_1c(state)

  Ğ¨Ğ°Ğ³ B.1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

  counterparty_data = self._prepare_counterparty_data(state)
  # Ğ¢Ğµ Ğ¶Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡Ñ‚Ğ¾ Ğ¸ Ğ² ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ A

  Ğ¨Ğ°Ğ³ B.2: Ğ’Ñ‹Ğ·Ğ¾Ğ² OneCService.add_agreement_to_existing_counterparty()

  Ğ¤Ğ°Ğ¹Ğ»: backend/app/services/oneÑ_service.py (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ 419-599)

  Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:
  counterparty_uuid = "550e8400-e29b-41d4-a716-446655440000"  # UUID ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾

  contract_data = {
      "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
      "contract_number": "123/2024",
      "contract_date": "2024-01-15",
      "contract_price": 1000000.00,
      "all_services": [...],
      "payment_deferral_days": 30,
      "role": "Ğ—Ğ°ĞºĞ°Ğ·Ñ‡Ğ¸Ğº",
      ...
  }

  document_path = "/uploads/contracts/contract_123_uuid.docx"
  raw_text = "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°..."

  Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ params Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:
  # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°
  agreement_description = "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ â„–123/2024 Ğ¾Ñ‚ 15.01.2024"

  params = {
      "counterparty_uuid": "550e8400-e29b-41d4-a716-446655440000",

      # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸
      "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
      "contract_number": "123/2024",
      "contract_date": "2024-01-15",
      "contract_price": 1000000.0,
      "vat_percent": 20.0,
      "vat_type": "Ğ’ĞºĞ»ÑÑ‡ĞµĞ½ Ğ² Ñ†ĞµĞ½Ñƒ",
      "service_description": "ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸",
      "services": [
          {"name": "ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸", "quantity": 100, ...}
      ],

      # ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°
      "create_agreement": True,
      "agreement_description": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ â„–123/2024 Ğ¾Ñ‚ 15.01.2024",
      "is_supplier": False,
      "is_buyer": True,
      "allowed_debt_days": 30,

      "raw_text": "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚...",
      ...
  }

  HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº MCP Service:
  {
      "command": "add_note",
      "params": {
          "counterparty_uuid": "550e8400-e29b-41d4-a716-446655440000",
          "create_agreement": true,
          "agreement_description": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ â„–123/2024 Ğ¾Ñ‚ 15.01.2024",
          "contract_name": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ° Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³",
          "contract_number": "123/2024",
          "contract_date": "2024-01-15",
          "contract_price": 1000000.0,
          "services": [...],
          "is_supplier": false,
          "is_buyer": true,
          "allowed_debt_days": 30,
          ...
      }
  }

  ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ MCP/1Ğ¡:
  {
      "status": "success",
      "result": {
          "uuid": "550e8400-e29b-41d4-a716-446655440003",
          "agreement_uuid": "550e8400-e29b-41d4-a716-446655440004",
          "entity": {
              "Ref": "InformationRegister.Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸...",
              "ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ": "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ â„–123/2024 Ğ¾Ñ‚ 15.01.2024"
          }
      }
  }

  Ğ¨Ğ°Ğ³ B.3: ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°

  await self.attach_file(
      entity_uuid="550e8400-e29b-41d4-a716-446655440000",
      file_path="/uploads/contracts/contract_123_uuid.docx",
      agreement_uuid="550e8400-e29b-41d4-a716-446655440004"
  )

  Ğ¨Ğ°Ğ³ B.4: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”

  Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° counterparty_1c:
  Counterparty1C(
      id=2,
      contract_data_id=123,
      entity_uuid="550e8400-e29b-41d4-a716-446655440000",  # ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°Ğ³ĞµĞ½Ñ‚
      agreement_uuid="550e8400-e29b-41d4-a716-446655440004",  # Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€
      status_1c=OneCStatus.CREATED,
      created_in_1c_at="2024-01-15T10:35:00",
      response_from_1c={...},
      error_from_1c=None
  )

  ---
  ğŸ“Š Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ ĞœĞ•Ğ¢ĞĞ”ĞĞ’
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚      Ğ­Ñ‚Ğ°Ğ¿       â”‚                  ĞœĞµÑ‚Ğ¾Ğ´                   â”‚             Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ             â”‚           Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 1. Upload       â”‚ POST /upload                             â”‚ file: UploadFile                       â”‚ contract_id, task_id                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 2. Task         â”‚ process_contract_task()                  â”‚ contract_id, document_path             â”‚ AgentState                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 3. Orchestrator â”‚ process_contract()                       â”‚ contract_id, document_path             â”‚ AgentState                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 4. LLM Extract  â”‚ _extract_contract_data()                 â”‚ state.raw_text                         â”‚ state.extracted_data                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 5. LLM Services â”‚ _extract_all_services()                  â”‚ state.raw_text                         â”‚ state.extracted_data['all_services'] â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 6. Check 1C     â”‚ find_counterparty_by_inn()               â”‚ inn: str                               â”‚ {uuid, ...} Ğ¸Ğ»Ğ¸ None                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 7a. Create      â”‚ create_counterparty()                    â”‚ contract_data, document_path           â”‚ {uuid, agreement_uuid}               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 7b. Add         â”‚ add_agreement_to_existing_counterparty() â”‚ counterparty_uuid, contract_data       â”‚ {note_uuid, agreement_uuid}          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 8. Attach       â”‚ attach_file()                            â”‚ entity_uuid, file_path, agreement_uuid â”‚ bool                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ---
  ğŸ”— ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• Ğ¤ĞĞ™Ğ›Ğ«
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Ğ¤Ğ°Ğ¹Ğ»                    â”‚          ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/api/v1/endpoints/contracts.py â”‚ API endpoints               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/tasks/processing_tasks.py     â”‚ Celery tasks                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/agent/orchestrator.py         â”‚ Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ pipeline            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/services/oneÑ_service.py      â”‚ Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ 1Ğ¡             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/models/contract_schemas.py    â”‚ Pydantic ÑÑ…ĞµĞ¼Ñ‹              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ backend/app/models/database.py            â”‚ SQLAlchemy Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ mcp_service/server/mcp_server.py          â”‚ MCP ÑĞµÑ€Ğ²ĞµÑ€ (ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ 1Ğ¡) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ» Baked for 2m 50s